{"version":3,"sources":["index.es6"],"names":["createInstance","util","_","async","path","HASH_CODE_LENGTH","pools","Symbol","randomInt","min","max","Math","floor","random","randomString","length","chars","str","i","substr","randomHex","buffer","Buffer","toString","log","data","stack","debug","process","env","NODE_ENV","PoolDictionary","_length","Object","defineProperty","get","set","value","configurable","enumerable","key","hasOwnProperty","self","keys","forEach","x","DataPool","options","_extend","size","reserved","timeout","lifetime","available","inUse","listeners","state","adapter_","adapter","config","global","application","app","adapters","adapterTypes","require","join","cwd","e","er","name","namedAdapter","find","Error","code","adapterType","invariantName","adapterModule","type","callback","eachSeries","cb","item","close","err","newObj","nowTime","Date","getTime","hashCode","obj","createdAt","createObject","res","setTimeout","push","releasedObj","clearTimeout","pooledObj","inUseKeys","format","newObject","result","queryLifetimeForObject","waitForObject","listener","shift","call","used","PoolAdapter","pool","base","open","getObject","lastIdentity","releaseObject","query","values","execute","batch","entity","attribute","selectIdentity","createView","fn","executeInTransaction","migrate","on","isNil","cleanup"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\nimport util from 'util';\nimport {_} from 'lodash';\nimport async from 'async';\nimport path from 'path';\nconst HASH_CODE_LENGTH = 6;\n\nconst pools = Symbol('pools');\n/**\n * @function\n * @param min\n * @param max\n * @returns {*}\n */\nfunction randomInt(min, max) {\n    return Math.floor(Math.random()*max) + min;\n}\n\nfunction randomString(length) {\n\n    length = length || 16;\n    const chars = \"abcdefghkmnopqursuvwxz2456789ABCDEFHJKLMNPQURSTUVWXYZ\";\n    let str = \"\";\n    for(let i = 0; i < length; i++) {\n        str += chars.substr(randomInt(0, chars.length-1),1);\n    }\n    return str;\n}\n\nfunction randomHex(length) {\n\n    const buffer = new Buffer(randomString(length));\n    return buffer.toString('hex');\n}\n\nfunction log(data) {\n    util.log(data);\n    if (data.stack) {\n        util.log(data.stack);\n    }\n}\n\nfunction debug(data) {\n    if (process.env.NODE_ENV==='development')\n        log(data);\n}\n\n/**\n * @class PoolDictionary\n * @constructor\n */\nclass PoolDictionary {\n    constructor() {\n        let _length = 0;\n        Object.defineProperty(this, 'length', {\n            get: function() {\n                return _length;\n            },\n            set: function(value) {\n                _length = value;\n            }, configurable:false, enumerable:false\n        });\n    }\n\n    exists(key) {\n        return this.hasOwnProperty(key);\n    }\n\n    push(key, value) {\n        if (this.hasOwnProperty(key)) {\n            this[key] = value;\n        }\n        else {\n            this[key] = value;\n            this.length += 1;\n        }\n    }\n\n    pop(key) {\n        if (this.hasOwnProperty(key)) {\n            delete this[key];\n            this.length -= 1;\n            return 1;\n        }\n        return 0;\n    }\n\n    clear() {\n        const self = this, keys = _.keys(this);\n        _.forEach(keys, function(x) {\n            if (self.hasOwnProperty(x)) {\n                delete self[x];\n                self.length -= 1;\n            }\n        });\n        this.length = 0;\n    }\n\n    unshift() {\n        for(const key in this) {\n            if (this.hasOwnProperty(key)) {\n                const value = this[key];\n                delete this[key];\n                this.length -= 1;\n                return value;\n            }\n        }\n    }\n}\n\n/**\n * @class\n * @property {*} options\n */\nexport class DataPool {\n    /**\n     * @constructor\n     * @param {*=} options\n     */\n    constructor(options) {\n        this.options = util._extend({ size:20, reserved:2, timeout:30000, lifetime:1200000 }, options);\n        /**\n         * A collection of objects which represents the available pooled data adapters.\n         */\n        this.available = new PoolDictionary();\n        /**\n         * A collection of objects which represents the pooled data adapters that are currently in use.\n         */\n        this.inUse = new PoolDictionary();\n        /**\n         * An array of listeners that are currently waiting for a pooled data adapter.\n         * @type {Function[]}\n         */\n        this.listeners = [ ];\n        //set default state to active\n        this.state = 'active';\n\n    }\n\n    createObject() {\n        //if local adapter module has been already loaded\n        if (typeof this.adapter_ !== 'undefined') {\n            //create adapter instance and return\n            return this.adapter_.createInstance(this.options.adapter.options);\n        }\n\n        this.options = this.options || {};\n        /**\n         * @type {{adapters:Array, adapterTypes:Array}|*}\n         */\n        let config;\n        if (global && global.application) {\n            const app = global.application;\n            config = app.config || { adapters:[], adapterTypes:[] };\n        }\n        else {\n            //try to load config file\n            try {\n                config = require(path.join(process.cwd(),'app/config.json'));\n            }\n            catch(e) {\n                log('Configuration file cannot be loaded due to internal error.');\n                log(e);\n                //config cannot be load (do nothing)\n                config = { adapters:[], adapterTypes:[] };\n            }\n        }\n        let adapter = this.options.adapter, er;\n        if (typeof this.options.adapter === 'string') {\n            const name = this.options.adapter;\n            //try to load adapter settings from configuration\n            config.adapters = config.adapters || [];\n            const namedAdapter = _.find(config.adapters, function(x) { return x.name === name; });\n            if (typeof namedAdapter === 'undefined') {\n                er = new Error('The specified data adapter cannot be found.');\n                er.code = 'ECONF';\n                throw er;\n            }\n            this.options.adapter = namedAdapter;\n            adapter = this.options.adapter;\n        }\n        if (typeof adapter === 'undefined' || adapter === null) {\n            er = new Error('The base data adapter cannot be empty at this context.');\n            er.code = 'ECONF';\n            throw er;\n        }\n        //get adapter's invariant name\n        const adapterType = _.find(config.adapterTypes, function(x) { return x.invariantName===adapter.invariantName; });\n        let adapterModule;\n        if (typeof adapterType === 'undefined') {\n            er = new Error('The base data adapter cannot be found.');\n            er.code = 'ECONF';\n            throw er;\n        }\n        try {\n            adapterModule = require(adapterType.type);\n        }\n        catch(e) {\n            log(e);\n            er = new Error('Base data adapter cannot be loaded due to internal error.');\n            er.code = 'ECONF';\n            throw er;\n        }\n        if (typeof adapterModule.createInstance !== 'function') {\n            er = new Error('Base data adapter module createInstance() method is missing or is not yet implemented.');\n            er.code = 'EMOD';\n            throw er;\n        }\n        //hold adapter module\n        this.adapter_ = adapterModule;\n        return this.adapter_.createInstance(adapter.options);\n    }\n\n    cleanup(callback) {\n        try {\n            const self = this;\n            self.state = 'paused';\n            const keys = _.keys(self.available);\n            async.eachSeries(keys, function(key,cb) {\n                const item = self.available[key];\n               if (typeof item === 'undefined' || item === null) { return cb(); }\n                if (typeof item.close === 'function') {\n                    item.close(function() {\n                        cb();\n                    });\n                }\n            }, function(err) {\n                callback(err);\n                //clear available collection\n                _.forEach(keys, function(key) {\n                    delete self.available[key];\n                });\n                self.state = 'active';\n            });\n        }\n        catch(e) {\n            callback(e);\n        }\n    }\n\n    /**\n     * Queries data adapter lifetime in order to release an object which exceeded the defined lifetime limit.\n     * If such an object exists, releases data adapter and creates a new one.\n     * @private\n     * @param {Function} callback\n     */\n    queryLifetimeForObject(callback) {\n        const self = this;\n        const keys = _.keys(self.inUse);\n        let newObj;\n        if (keys.length===0) { return callback(); }\n        if (self.options.lifetime>0) {\n            const nowTime = (new Date()).getTime();\n            async.eachSeries(keys, function(hashCode,cb) {\n                const obj = self.inUse[hashCode];\n                if (typeof obj === 'undefined' || obj === null) {\n                    return cb();\n                }\n                if (nowTime>(obj.createdAt.getTime()+self.options.lifetime)) {\n                    if (typeof obj.close !== 'function') {\n                        return cb();\n                    }\n                    //close data adapter (the client which is using this adapter may get an error for this, but this data adapter has been truly timed out)\n                    obj.close(function() {\n                        //create new object (data adapter)\n                        newObj = self.createObject();\n                        //add createdAt property\n                        newObj.createdAt = new Date();\n                        //add object hash code property\n                        newObj.hashCode = randomHex(HASH_CODE_LENGTH);\n                        //delete inUse object\n                        delete self.inUse[hashCode];\n                        //push object in inUse collection\n                        self.inUse[newObj.hashCode] = newObj;\n                        //return new object\n                        return cb(newObj);\n                    });\n                }\n                else {\n                    cb();\n                }\n            }, function(res) {\n                if (res instanceof Error) {\n                    callback(res);\n                }\n                else {\n                    callback(null, res);\n                }\n            });\n        }\n        else {\n            callback();\n        }\n    }\n\n    /**\n     * @private\n     * @param {Function} callback\n     */\n    waitForObject(callback) {\n        const self = this;\n        let timeout;\n        let newObj;\n        //register a connection pool timeout\n        timeout = setTimeout(function() {\n            //throw timeout exception\n            const er = new Error('Connection pool timeout.');\n            er.code = 'EPTIMEOUT';\n            callback(er);\n        }, self.options.timeout);\n        self.listeners.push(function(releasedObj) {\n            //clear timeout\n            if (timeout) {\n                clearTimeout(timeout);\n            }\n            if (releasedObj) {\n                //push (update) released object in inUse collection\n                releasedObj.createdAt = new Date();\n                self.inUse[releasedObj.hashCode] = releasedObj;\n                //return new object\n                return callback(null, releasedObj);\n            }\n            const keys = _.keys(self.available);\n            if (keys.length>0) {\n                const key = keys[0];\n                //get connection from available connections\n                const pooledObj = self.available[key];\n                delete self.available[key];\n                //push object in inUse collection\n                self.inUse[pooledObj.hashCode] = pooledObj;\n                //return pooled object\n                callback(null, pooledObj);\n            }\n            else {\n                //create new object\n                newObj = self.createObject();\n                //add createdAt property\n                newObj.createdAt = new Date();\n                //add object hash code\n                newObj.hashCode = randomHex(HASH_CODE_LENGTH);\n                //push object in inUse collection\n                self.inUse[newObj.hashCode] = newObj;\n                //return new object\n                callback(null, newObj);\n            }\n        });\n    }\n\n    /**\n     * @private\n     * @param {Function} callback\n     */\n    newObject(callback) {\n        const self = this;\n        let newObj;\n        for(const key in self.available) {\n            if (self.available.hasOwnProperty(key)) {\n                //get available object\n                newObj = self.available[key];\n                //delete available key from collection\n                delete self.available[key];\n                //add createdAt property\n                newObj.createdAt = new Date();\n                //push object in inUse collection\n                self.inUse[newObj.hashCode] = newObj;\n                //and finally return it\n                return callback(null, newObj);\n            }\n        }\n        //otherwise create new object\n        newObj = self.createObject();\n        //add createdAt property\n        newObj.createdAt = new Date();\n        //add object hash code\n        newObj.hashCode = randomHex(HASH_CODE_LENGTH);\n        //push object in inUse collection\n        self.inUse[newObj.hashCode] = newObj;\n        //return new object\n        return callback(null, newObj);\n    }\n\n    /**\n     *\n     * @param {Function} callback\n     */\n    getObject(callback) {\n        const self = this;\n        callback = callback || function() {};\n\n        if (self.state !== 'active') {\n            const er = new Error('Connection refused due to pool state.');\n            er.code = 'EPSTATE';\n            return callback(er);\n        }\n        const inUseKeys = _.keys(self.inUse);\n        debug(util.format(\"INFO (DataPool): Connections in use:%s\", inUseKeys.length));\n        if ((inUseKeys.length < self.options.size) || (self.options.size === 0)) {\n            debug(\"INFO  (DataPool): Creating new object in data pool.\");\n            self.newObject(function(err, result) {\n                if (err) { return callback(err); }\n                return callback(null, result);\n            });\n        }\n        else {\n            self.queryLifetimeForObject(function(err, result) {\n                if (err) { return callback(err); }\n                if (result) { return callback(null, result); }\n                debug(\"INFO (DataPool): Waiting for an object from data pool.\");\n                self.waitForObject(function(err, result) {\n                    if (err) { return callback(err); }\n                    callback(null, result);\n                });\n            });\n        }\n    }\n\n    /**\n     *\n     * @param {*} obj\n     * @param {Function} callback\n     */\n    releaseObject(obj, callback) {\n        const self = this;\n        callback = callback || function() {};\n        if (typeof obj === 'undefined' || obj === null) {\n            return callback();\n        }\n        try {\n            //get the first listener\n            const listener = self.listeners.shift();\n            //if listener exists\n            if (typeof listener === 'function') {\n                //execute listener\n                if (typeof obj.hashCode === 'undefined' || obj.hashCode === null) {\n                    //generate hashCode\n                    obj.hashCode = randomHex(HASH_CODE_LENGTH);\n                }\n                if (self.inUse.hasOwnProperty(obj.hashCode)) {\n                    //call listener with the released object as parameter\n                    listener.call(self, obj);\n                }\n                else {\n                    //validate released object\n                    if (typeof obj.close === 'function') {\n                        try {\n                            //call close() method\n                            obj.close();\n                            //call listener without any parameter\n                            listener.call(self);\n                        }\n                        catch(e) {\n                            log('An error occured while trying to release an unknown data adapter');\n                            log(e);\n                            //call listener without any parameter\n                            listener.call(self);\n                        }\n                    }\n                }\n            }\n            else {\n                //search inUse collection\n                debug(\"INFO (DataPool): Releasing object from data pool.\");\n                const used = this.inUse[obj.hashCode];\n                if (typeof used !== 'undefined') {\n                    //delete used adapter\n                    delete this.inUse[obj.hashCode];\n                    //push data adapter to available collection\n                    self.available[used.hashCode] = used;\n                    debug(util.format(\"INFO (DataPool): Object released. Connections in use %s.\", this.inUse.length));\n                }\n            }\n            //finally exit\n            callback();\n        }\n        catch(e) {\n            callback(e);\n        }\n    }\n}\n\n/**\n * @class\n */\nexport class PoolAdapter {\n    /**\n     * @constructor\n     * @augments DataAdapter\n     * @property {DataAdapter} base\n     * @property {DataPool} pool\n     */\n    constructor(options) {\n        this.options = options;\n        const self = this;\n        Object.defineProperty(this, 'pool', {\n            get: function() {\n                return DataPool[pools][self.options.pool];\n            }, configurable:false, enumerable:false\n        });\n        \n    }\n\n    /**\n     * @private\n     * @param callback\n     */\n    open(callback) {\n        const self = this;\n        if (self.base) {\n            return self.base.open(callback);\n        }\n        else {\n            self.pool.getObject(function(err, result) {\n                if (err) { return callback(err); }\n                self.base = result;\n                if (typeof self.base.lastIdentity === 'function') {\n                    self.lastIdentity = function(callback) {\n                        return this.base.lastIdentity(callback);\n                    };\n                }\n                self.base.open(callback);\n            });\n        }\n    }\n\n    /**\n     * Closes the underlying database connection\n     * @param callback {function(Error=)}\n     */\n    close(callback) {\n        callback = callback || function() {};\n        const self = this;\n        if (self.base) {\n            self.pool.releaseObject(self.base,callback);\n            if (typeof self.base.lastIdentity === 'function') {\n                delete self.lastIdentity;\n            }\n            delete self.base;\n        }\n        else {\n            callback();\n        }\n    }\n\n    /**\n     * Executes a query and returns the result as an array of objects.\n     * @param query {string|*}\n     * @param values {*}\n     * @param callback {Function}\n     */\n    execute(query, values, callback) {\n        const self = this;\n        self.open(function(err) {\n            if (err) { return callback(err); }\n            self.base.execute(query, values, callback);\n        });\n    }\n\n    /**\n     * Executes an operation against database and returns the results.\n     * @param batch {*}\n     * @param callback {Function=}\n     */\n    executeBatch(batch, callback) {\n        callback(new Error('This method is obsolete. Use DataAdapter.executeInTransaction() instead.'));\n    }\n\n    /**\n     * Produces a new identity value for the given entity and attribute.\n     * @param entity {String} The target entity name\n     * @param attribute {String} The target attribute\n     * @param callback {Function=}\n     */\n    selectIdentity(entity, attribute, callback) {\n        const self = this;\n        self.open(function(err) {\n            if (err) { return callback(err); }\n            if (typeof self.base.selectIdentity !== 'function') {\n                return callback(new Error('This method is not yet implemented. The base DataAdapter object does not implement this method..'));\n            }\n            self.base.selectIdentity(entity, attribute , callback);\n        });\n    }\n\n    /**\n     * Creates a database view if the current data adapter supports views\n     * @param {string} name A string that represents the name of the view to be created\n     * @param {QueryExpression} query The query expression that represents the database vew\n     * @param {Function} callback A callback function to be called when operation will be completed.\n     */\n    createView(name, query, callback) {\n        const self = this;\n        self.open(function(err) {\n            if (err) { return callback(err); }\n            self.base.createView(name, query, callback);\n        });\n    }\n\n    /**\n     * Begins a transactional operation by executing the given function\n     * @param fn {Function} The function to execute\n     * @param callback {Function} The callback that contains the error -if any- and the results of the given operation\n     */\n    executeInTransaction(fn, callback) {\n        const self = this;\n        self.open(function(err) {\n            if (err) { return callback(err); }\n            self.base.executeInTransaction(fn, callback);\n        });\n    }\n\n    /**\n     *\n     * @param obj {DataModelMigration|*} An Object that represents the data model scheme we want to migrate\n     * @param callback {Function}\n     */\n    migrate(obj, callback) {\n        const self = this;\n        self.open(function(err) {\n            if (err) { return callback(err); }\n            self.base.migrate(obj, callback);\n        });\n    }\n}\n/**\n * @param {*} options\n */\nexport function createInstance(options) {\n    let name, er;\n    if (typeof options.adapter === 'undefined' || options.adapter === null) {\n        er = new Error('Invalid argument. The target data adapter is missing.');\n        er.code = 'EARG';\n        throw er;\n    }\n    //init pool collection\n    DataPool[pools] = DataPool[pools] || {};\n\n    //get adapter's name\n    if (typeof options.adapter === 'string') {\n        name = options.adapter;\n    }\n    else if (typeof options.adapter.name === 'string') {\n        name = options.adapter.name;\n    }\n    //validate name\n    if (typeof name === 'undefined') {\n        er = new Error('Invalid argument. The target data adapter name is missing.');\n        er.code = 'EARG';\n        throw er;\n    }\n    /**\n     * @type {DataPool}\n     */\n    let pool = DataPool[pools][name];\n    if (typeof pool === 'undefined' || pool === null) {\n        //create new pool with the name specified in options\n        DataPool.pools[name] = new DataPool(options);\n    }\n    return new PoolAdapter({ pool:name });\n}\n\nprocess.on('exit', function() {\n    if (_.isNil(DataPool[pools])) { return; }\n    try {\n        const keys = _.keys(DataPool[pools]);\n        _.forEach(keys, function(x) {\n            try {\n                log(util.format('Cleaning up data pool (%s)', x));\n                if (typeof DataPool[pools][x] === 'undefined' || DataPool[pools][x] === null) { return; }\n                if (typeof DataPool[pools][x].cleanup === 'function') {\n                    DataPool[pools][x].cleanup(function() {\n                        //do nothing\n                    });\n                }\n            }\n            catch(err) {\n                debug(err);\n            }\n        });\n    }\n    catch(err) {\n        debug(err);\n    }\n\n});\n"]}