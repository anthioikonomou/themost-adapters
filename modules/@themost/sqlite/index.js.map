{"version":3,"sources":["index.es6"],"names":["createInstance","async","_","util","SqlFormatter","sqlite","TraceUtils","SqlUtils","QueryExpression","QueryField","sqlite3","verbose","SqliteAdapter","options","database","rawConnection","callback","self","Database","err","close","log","query","values","prepare","fn","open","transaction","call","run","undefined","name","view","create","obj","isNil","migration","format","result","test","replace","formatType","waterfall","cb","supportMigrations","table","exists","arg","execute","appliesTo","version","updated","columns","args","strFields","add","filter","x","map","join","sql","expressions","forceAlter","column","newType","oldType","isArray","remove","i","colIndex","findIndex","y","primary","splice","length","change","find","type","toUpperCase","concat","nullable","push","Error","forEach","eachSeries","expr","indexes","tableIndexes","index","indexCallback","model","description","entity","attribute","size","migrate","q","select","max","value","parseInt","id","batch","count","has_sequence","arr","iterator","col","ordinal","cid","notnull","pk","matches","exec","scale","drop","thisArg","executeInTransaction","tr","formatter","SqliteFormatter","e","process","env","NODE_ENV","JSON","stringify","prepared","all","keys","Object","lastval","insertId","list","this1","hasOwnProperty","origin","cols","apply","ix","sqlCreateIndex","escapeName","nCols","indexOf","field","s","zeroPad","number","res","toString","settings","nameFormat","NAME_FORMAT","forceAlias","unquoted","Date","escapeDate","bind","REGEXP_SINGLE_QUOTE","SINGLE_QUOTE_ESCAPE","REGEXP_DOUBLE_QUOTE","DOUBLE_QUOTE_ESCAPE","REGEXP_SLASH","SLASH_ESCAPE","val","year","getFullYear","month","getMonth","day","getDate","hour","getHours","minute","getMinutes","second","getSeconds","millisecond","getMilliseconds","offset","getTimezoneOffset","timezone","Math","floor","p0","p1","escape","s1","pos","valueOf"],"mappings":"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","file":"index.js","sourcesContent":["/**\r\n * @license\r\n * MOST Web Framework 2.0 Codename Blueshift\r\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\r\n *                     Anthi Oikonomou anthioikonomou@gmail.com\r\n *\r\n * Use of this source code is governed by an BSD-3-Clause license that can be\r\n * found in the LICENSE file at https://themost.io/license\r\n */\r\nimport 'source-map-support/register';\r\nimport async from 'async';\r\nimport _ from 'lodash';\r\nimport util from 'util';\r\nimport {SqlFormatter} from '@themost/query/formatter';\r\nimport sqlite from 'sqlite3';\r\nimport {TraceUtils} from \"@themost/common/utils\";\r\nimport {SqlUtils} from \"@themost/query/utils\";\r\nimport {QueryExpression,QueryField} from \"@themost/query/query\";\r\nconst sqlite3 = sqlite.verbose();\r\n\r\n/**\r\n * @class\r\n * @augments DataAdapter\r\n * @param {*} options\r\n * @constructor\r\n */\r\nexport class SqliteAdapter {\r\n    \r\n    constructor(options) {\r\n        /**\r\n         * @type {{database: string}}\r\n         */\r\n        this.options = options || { database: ':memory:' };\r\n        /**\r\n         * Represents the database raw connection associated with this adapter\r\n         * @type {*}\r\n         */\r\n        this.rawConnection = null;\r\n    }\r\n\r\n    open(callback) {\r\n        const self = this;\r\n        callback = callback || function() {};\r\n        if (self.rawConnection) {\r\n            callback();\r\n        }\r\n        else {\r\n            //try to open or create database\r\n            self.rawConnection = new sqlite3.Database(self.options.database,6, function(err) {\r\n                if (err) {\r\n                    self.rawConnection = null;\r\n                }\r\n                callback(err);\r\n\r\n            });\r\n        }\r\n    }\r\n\r\n    close(callback) {\r\n        const self = this;\r\n        callback = callback || function() {};\r\n        try {\r\n            if (self.rawConnection)\r\n            {\r\n                //close connection\r\n                self.rawConnection.close(function() {\r\n                    //and finally return\r\n                    callback();\r\n                });\r\n            }\r\n            else {\r\n                callback();\r\n            }\r\n\r\n        }\r\n        catch (err) {\r\n            TraceUtils.log('An error occured while closing database.');\r\n            TraceUtils.log(err);\r\n            //call callback without error\r\n            callback();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param {string} query\r\n     * @param {*=} values\r\n     */\r\n    prepare(query, values) {\r\n        return SqlUtils.prepare(query,values);\r\n    }\r\n\r\n    static formatType(field) {\r\n        const size = parseInt(field.size);\r\n        let s;\r\n        switch (field.type)\r\n        {\r\n            case 'Boolean':\r\n                s = 'INTEGER(1,0)';\r\n                break;\r\n            case 'Byte':\r\n                s = 'INTEGER(1,0)';\r\n                break;\r\n            case 'Number':\r\n            case 'Float':\r\n                s = 'REAL';\r\n                break;\r\n            case 'Counter':\r\n                return 'INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL';\r\n            case 'Currency':\r\n                s =  'NUMERIC(' + (field.size || 19) + ',4)';\r\n                break;\r\n            case 'Decimal':\r\n                s =  'NUMERIC';\r\n                if ((field.size) && (field.scale)) { s += '(' + field.size + ',' + field.scale + ')'; }\r\n                break;\r\n            case 'Date':\r\n            case 'DateTime':\r\n                s = 'NUMERIC';\r\n                break;\r\n            case 'Time':\r\n                s = size>0 ?  util.format('TEXT(%s,0)', size) : 'TEXT';\r\n                break;\r\n            case 'Long':\r\n            case 'Duration':\r\n                s = size>0 ?  util.format('TEXT(%s,0)', size) : 'TEXT';\r\n                break;\r\n            case 'Integer':\r\n                s = 'INTEGER' + (field.size ? '(' + field.size + ',0)':'' );\r\n                break;\r\n            case 'URL':\r\n            case 'Text':\r\n            case 'Note':\r\n                s =field.size ? util.format('TEXT(%s,0)', field.size) : 'TEXT';\r\n                break;\r\n            case 'Image':\r\n            case 'Binary':\r\n                s ='BLOB';\r\n                break;\r\n            case 'Guid':\r\n                s = 'TEXT(36,0)';\r\n                break;\r\n            case 'Short':\r\n                s = 'INTEGER(2,0)';\r\n                break;\r\n            default:\r\n                s = 'INTEGER';\r\n                break;\r\n        }\r\n        if (field.primary) {\r\n            return s.concat(' PRIMARY KEY NOT NULL');\r\n        }\r\n        else {\r\n            return s.concat((field.nullable===undefined) ? ' NULL': (field.nullable ? ' NULL': ' NOT NULL'));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Begins a transactional operation by executing the given function\r\n     * @param fn {function} The function to execute\r\n     * @param callback {function(Error=)} The callback that contains the error -if any- and the results of the given operation\r\n     */\r\n    executeInTransaction(fn, callback) {\r\n        const self = this;\r\n        //ensure parameters\r\n        fn = fn || function() {}; callback = callback || function() {};\r\n        self.open(function(err) {\r\n            if (err) {\r\n                callback(err);\r\n            }\r\n            else {\r\n                if (self.transaction) {\r\n                    fn.call(self, function(err) {\r\n                        callback(err);\r\n                    });\r\n                }\r\n                else {\r\n                    //begin transaction\r\n                    self.rawConnection.run('BEGIN TRANSACTION;', undefined, function(err) {\r\n                        if (err) {\r\n                            callback(err);\r\n                            return;\r\n                        }\r\n                        //initialize dummy transaction object (for future use)\r\n                        self.transaction = { };\r\n                        //execute function\r\n                        fn.call(self, function(err) {\r\n                            if (err) {\r\n                                //rollback transaction\r\n                                self.rawConnection.run('ROLLBACK;', undefined, function() {\r\n                                    self.transaction = null;\r\n                                    callback(err);\r\n                                });\r\n                            }\r\n                            else {\r\n                                //commit transaction\r\n                                self.rawConnection.run('COMMIT;', undefined, function(err) {\r\n                                    self.transaction = null;\r\n                                    callback(err);\r\n                                });\r\n                            }\r\n                        });\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} name\r\n     * @param {QueryExpression|*} query\r\n     * @param {function(Error=)} callback\r\n     */\r\n    createView(name, query, callback) {\r\n        this.view(name).create(query, callback);\r\n    }\r\n\r\n    /*\r\n     * @param {DataModelMigration|*} obj An Object that represents the data model scheme we want to migrate\r\n     * @param {function(Error=)} callback\r\n     */\r\n    migrate(obj, callback) {\r\n        const self = this;\r\n        callback = callback || function() {};\r\n        if (_.isNil(obj)) { return callback(); }\r\n        /**\r\n         * @type {DataModelMigration|*}\r\n         */\r\n        const migration = obj;\r\n\r\n        const format = function(format, obj)\r\n        {\r\n            let result = format;\r\n            if (/%t/.test(format))\r\n                result = result.replace(/%t/g,SqliteAdapter.formatType(obj));\r\n            if (/%f/.test(format))\r\n                result = result.replace(/%f/g,obj.name);\r\n            return result;\r\n        };\r\n\r\n\r\n        async.waterfall([\r\n            //1. Check migrations table existence\r\n            function(cb) {\r\n                if (SqliteAdapter.supportMigrations) {\r\n                    cb(null, true);\r\n                    return;\r\n                }\r\n                self.table('migrations').exists(function(err, exists) {\r\n                    if (err) { cb(err); return; }\r\n                    cb(null, exists);\r\n                });\r\n            },\r\n            //2. Create migrations table, if it does not exist\r\n            function(arg, cb) {\r\n                if (arg) { cb(null, 0); return; }\r\n                //create migrations table\r\n                self.execute('CREATE TABLE migrations(\"id\" INTEGER PRIMARY KEY AUTOINCREMENT, ' +\r\n                    '\"appliesTo\" TEXT NOT NULL, \"model\" TEXT NULL, \"description\" TEXT,\"version\" TEXT NOT NULL)',\r\n                    [], function(err) {\r\n                        if (err) { cb(err); return; }\r\n                        SqliteAdapter.supportMigrations=true;\r\n                        cb(null, 0);\r\n                    });\r\n            },\r\n            //3. Check if migration has already been applied (true=Table version is equal to migration version, false=Table version is older from migration version)\r\n            function(arg, cb) {\r\n                self.table(migration.appliesTo).version(function(err, version) {\r\n                    if (err) { cb(err); return; }\r\n                    cb(null, (version>=migration.version));\r\n                });\r\n            },\r\n            //4a. Check table existence (-1=Migration has already been applied, 0=Table does not exist, 1=Table exists)\r\n            function(arg, cb) {\r\n                //migration has already been applied (set migration.updated=true)\r\n                if (arg) {\r\n                    migration.updated=true;\r\n                    cb(null, -1);\r\n                }\r\n                else {\r\n                    self.table(migration.appliesTo).exists(function(err, exists) {\r\n                        if (err) { cb(err); return; }\r\n                        cb(null, exists ? 1 : 0);\r\n                    });\r\n\r\n                }\r\n            },\r\n            //4. Get table columns\r\n            function(arg, cb) {\r\n                //migration has already been applied\r\n                if (arg<0) { cb(null, [arg, null]); return; }\r\n                self.table(migration.appliesTo).columns(function(err, columns) {\r\n                    if (err) { cb(err); return; }\r\n                    cb(null, [arg, columns]);\r\n                });\r\n            },\r\n            //5. Migrate target table (create or alter)\r\n            function(args, cb) {\r\n                //migration has already been applied (args[0]=-1)\r\n                if (args[0] < 0) {\r\n                    cb(null, args[0]);\r\n                }\r\n                else if (args[0] === 0) {\r\n                    //create table\r\n                    const strFields = migration.add.filter(function(x) {\r\n                        return !x['oneToMany'];\r\n                    }).map(\r\n                        function(x) {\r\n                            return format('\"%f\" %t', x);\r\n                        }).join(', ');\r\n                    const sql = util.format('CREATE TABLE \"%s\" (%s)', migration.appliesTo, strFields);\r\n                    self.execute(sql, null, function(err) {\r\n                        if (err) { cb(err); return; }\r\n                        cb(null, 1);\r\n                    });\r\n                }\r\n                else if (args[0] === 1) {\r\n                    const expressions = [];\r\n\r\n                    const /**\r\n                     * @type {{columnName:string,ordinal:number,dataType:*, maxLength:number,isNullable:number,,primary:boolean }[]}\r\n                     */\r\n                    columns = args[1];\r\n\r\n                    let forceAlter = false;\r\n                    let column;\r\n                    let newType;\r\n                    let oldType;\r\n                    //validate operations\r\n\r\n                    //1. columns to be removed\r\n                    if (util.isArray(migration.remove)) {\r\n                        if (migration.remove>0) {\r\n                            for (let i = 0; i < migration.remove.length; i++) {\r\n                                let x = migration.remove[i];\r\n                                const colIndex = _.findIndex(columns, (y) => { return y.name === x.name; });\r\n                                if (colIndex>=0) {\r\n                                    if (!columns[colIndex].primary) {\r\n                                        forceAlter = true;\r\n                                    }\r\n                                    else {\r\n                                        migration.remove.splice(i, 1);\r\n                                        i-=1;\r\n                                    }\r\n                                }\r\n                                else {\r\n                                    migration.remove.splice(i, 1);\r\n                                    i-=1;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                    //1. columns to be changed\r\n                    if (util.isArray(migration.change)) {\r\n                        if (migration.change>0) {\r\n\r\n                            for (let i = 0; i < migration.change.length; i++) {\r\n                                let x = migration.change[i];\r\n                                column = _.find(function(y) { return y.name === x.name; });\r\n                                if (column) {\r\n                                    if (!column.primary) {\r\n                                        //validate new column type (e.g. TEXT(120,0) NOT NULL)\r\n                                        newType = format('%t', x); oldType = column.type.toUpperCase().concat(column.nullable ? ' NOT NULL' : ' NULL');\r\n                                        if ((newType !== oldType)) {\r\n                                            //force alter\r\n                                            forceAlter = true;\r\n                                        }\r\n                                    }\r\n                                    else {\r\n                                        //remove column from change collection (because it's a primary key)\r\n                                        migration.change.splice(i, 1);\r\n                                        i-=1;\r\n                                    }\r\n                                }\r\n                                else {\r\n                                    //add column (column was not found in table)\r\n                                    migration.add.push(x);\r\n                                    //remove column from change collection\r\n                                    migration.change.splice(i, 1);\r\n                                    i-=1;\r\n                                }\r\n\r\n                            }\r\n\r\n                        }\r\n                    }\r\n                    if (util.isArray(migration.add)) {\r\n\r\n                        for (let i = 0; i < migration.add.length; i++) {\r\n                            let x = migration.add[i];\r\n                            column = _.find(function(y) { return (y.name === x.name); });\r\n                            if (column) {\r\n                                if (column.primary) {\r\n                                    migration.add.splice(i, 1);\r\n                                    i-=1;\r\n                                }\r\n                                else {\r\n                                    newType = format('%t', x); oldType = column.type.toUpperCase().concat(column.nullable ? ' NOT NULL' : ' NULL');\r\n                                    if (newType === oldType) {\r\n                                        //remove column from add collection\r\n                                        migration.add.splice(i, 1);\r\n                                        i-=1;\r\n                                    }\r\n                                    else {\r\n                                        forceAlter = true;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                        if (forceAlter) {\r\n                            cb(new Error('Full table migration is not yet implemented.'));\r\n                            return;\r\n                        }\r\n                        else {\r\n                            migration.add.forEach(function(x) {\r\n                                //search for columns\r\n                                expressions.push(util.format('ALTER TABLE \"%s\" ADD COLUMN \"%s\" %s', migration.appliesTo, x.name, SqliteAdapter.formatType(x)));\r\n                            });\r\n                        }\r\n\r\n                    }\r\n                    if (expressions.length>0) {\r\n                        async.eachSeries(expressions, function(expr,cb) {\r\n                            self.execute(expr, [], function(err) {\r\n                                cb(err);\r\n                            });\r\n                        }, function(err) {\r\n                            if (err) { cb(err); return; }\r\n                            cb(null, 1);\r\n                        });\r\n                    }\r\n                    else {\r\n                        cb(null, 2);\r\n                    }\r\n                }\r\n                else {\r\n                    cb(new Error('Invalid table status.'));\r\n                }\r\n            },\r\n            //Apply data model indexes\r\n            function (arg, cb) {\r\n                if (arg<=0) { return cb(null, arg); }\r\n                if (migration.indexes) {\r\n                    const tableIndexes = self.indexes(migration.appliesTo);\r\n                    //enumerate migration constraints\r\n                    async.eachSeries(migration.indexes, function(index, indexCallback) {\r\n                        tableIndexes.create(index.name, index.columns, indexCallback);\r\n                    }, function(err) {\r\n                        //throw error\r\n                        if (err) { return cb(err); }\r\n                        //or return success flag\r\n                        return cb(null, 1);\r\n                    });\r\n                }\r\n                else {\r\n                    //do nothing and exit\r\n                    return cb(null, 1);\r\n                }\r\n            },\r\n            function(arg, cb) {\r\n                if (arg>0) {\r\n                    //log migration to database\r\n                    self.execute('INSERT INTO migrations(\"appliesTo\", \"model\", \"version\", \"description\") VALUES (?,?,?,?)', [migration.appliesTo,\r\n                        migration.model,\r\n                        migration.version,\r\n                        migration.description ], function(err) {\r\n                        if (err)  {\r\n                            return cb(err);\r\n                        }\r\n                        cb(null, 1);\r\n                    });\r\n                }\r\n                else {\r\n                    migration.updated = true;\r\n                    cb(null, arg);\r\n                }\r\n            }\r\n        ], function(err) {\r\n            callback(err);\r\n        });\r\n\r\n    }\r\n\r\n    /**\r\n     * Produces a new identity value for the given entity and attribute.\r\n     * @param entity {String} The target entity name\r\n     * @param attribute {String} The target attribute\r\n     * @param callback {Function=}\r\n     */\r\n    selectIdentity(entity, attribute, callback) {\r\n\r\n        const self = this;\r\n\r\n        const migration = {\r\n            appliesTo:'increment_id',\r\n            model:'increments',\r\n            description:'Increments migration (version 1.0)',\r\n            version:'1.0',\r\n            add:[\r\n                { name:'id', type:'Counter', primary:true },\r\n                { name:'entity', type:'Text', size:120 },\r\n                { name:'attribute', type:'Text', size:120 },\r\n                { name:'value', type:'Integer' }\r\n            ]\r\n        };\r\n        //ensure increments entity\r\n        self.migrate(migration, function(err)\r\n        {\r\n            //throw error if any\r\n            if (err) { callback.call(self,err); return; }\r\n            self.execute('SELECT * FROM increment_id WHERE entity=? AND attribute=?', [entity, attribute], function(err, result) {\r\n                if (err) { callback.call(self,err); return; }\r\n                if (result.length===0) {\r\n                    //get max value by querying the given entity\r\n                    const q = QueryExpression.create(entity).select(QueryField.create().max(attribute));\r\n                    self.execute(q,null, function(err, result) {\r\n                        if (err) { callback.call(self, err); return; }\r\n                        let value = 1;\r\n                        if (result.length>0) {\r\n                            value = (parseInt(result[0][attribute]) || 0)+ 1;\r\n                        }\r\n                        self.execute('INSERT INTO increment_id(entity, attribute, value) VALUES (?,?,?)',[entity, attribute, value], function(err) {\r\n                            //throw error if any\r\n                            if (err) { callback.call(self, err); return; }\r\n                            //return new increment value\r\n                            callback.call(self, err, value);\r\n                        });\r\n                    });\r\n                }\r\n                else {\r\n                    //get new increment value\r\n                    const value = parseInt(result[0].value) + 1;\r\n                    self.execute('UPDATE increment_id SET value=? WHERE id=?',[value, result[0].id], function(err) {\r\n                        //throw error if any\r\n                        if (err) { callback.call(self, err); return; }\r\n                        //return new increment value\r\n                        callback.call(self, err, value);\r\n                    });\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Executes an operation against database and returns the results.\r\n     * @param {*} batch\r\n     * @param {function(Error=)} callback\r\n     */\r\n    executeBatch(batch, callback) {\r\n        callback = callback || function() {};\r\n        callback(new Error('DataAdapter.executeBatch() is obsolete. Use DataAdapter.executeInTransaction() instead.'));\r\n    }\r\n\r\n    table(name) {\r\n        const self = this;\r\n        return {\r\n            /**\r\n             * @param {function(Error,Boolean=)} callback\r\n             */\r\n            exists:function(callback) {\r\n                self.execute('SELECT COUNT(*) count FROM sqlite_master WHERE name=? AND type=\\'table\\';', [name], function(err, result) {\r\n                    if (err) { callback(err); return; }\r\n                    callback(null, (result[0].count>0));\r\n                });\r\n            },\r\n            /**\r\n             * @param {function(Error,string=)} callback\r\n             */\r\n            version:function(callback) {\r\n                self.execute('SELECT MAX(version) AS version FROM migrations WHERE appliesTo=?',\r\n                    [name], function(err, result) {\r\n                        if (err) { return callback(err); }\r\n                        if (result.length === 0)\r\n                            callback(null, '0.0');\r\n                        else\r\n                            callback(null, result[0].version || '0.0');\r\n                    });\r\n            },\r\n            /**\r\n             * @param {function(Error,Boolean=)} callback\r\n             */\r\n            has_sequence:function(callback) {\r\n                callback = callback || function() {};\r\n                self.execute('SELECT COUNT(*) count FROM sqlite_sequence WHERE name=?',\r\n                    [name], function(err, result) {\r\n                        if (err) { callback(err); return; }\r\n                        callback(null, (result[0].count>0));\r\n                    });\r\n            },\r\n            /**\r\n             * @param {function(Error=,Array=)} callback\r\n             */\r\n            columns:function(callback) {\r\n                callback = callback || function() {};\r\n                self.execute('PRAGMA table_info(?)',\r\n                    [name], function(err, result) {\r\n                        if (err) { callback(err); return; }\r\n                        const arr = [];\r\n                        /**\r\n                         * enumerates table columns\r\n                         * @param {{name:string},{cid:number},{type:string},{notnull:number},{pk:number}} x\r\n                         */\r\n                        const iterator = function(x) {\r\n                            const col = { name: x.name, ordinal: x.cid, type: x.type,nullable: (x.notnull ? true : false), primary: (x.pk === 1) };\r\n                            const matches = /(\\w+)\\((\\d+),(\\d+)\\)/.exec(x.type);\r\n                            if (matches) {\r\n                                //extract max length attribute (e.g. integer(2,0) etc)\r\n                                if (parseInt(matches[2])>0) { col.size =  parseInt(matches[2]); }\r\n                                //extract scale attribute from field (e.g. integer(2,0) etc)\r\n                                if (parseInt(matches[3])>0) { col.scale =  parseInt(matches[3]); }\r\n                            }\r\n                            arr.push(col);\r\n                        };\r\n                        result.forEach(iterator);\r\n                        callback(null, arr);\r\n                    });\r\n            }\r\n        };\r\n\r\n    }\r\n\r\n    view(name) {\r\n        const self = this;\r\n        return {\r\n            /**\r\n             * @param {function(Error,Boolean=)} callback\r\n             */\r\n            exists:function(callback) {\r\n                self.execute('SELECT COUNT(*) count FROM sqlite_master WHERE name=? AND type=\\'view\\';', [name], function(err, result) {\r\n                    if (err) { callback(err); return; }\r\n                    callback(null, (result[0].count>0));\r\n                });\r\n            },\r\n            /**\r\n             * @param {function(Error=)} callback\r\n             */\r\n            drop:function(callback) {\r\n                callback = callback || function() {};\r\n                self.open(function(err) {\r\n                   if (err) { callback(err); return; }\r\n                    const sql = util.format(\"DROP VIEW IF EXISTS %s\",name);\r\n                    self.execute(sql, undefined, function(err) {\r\n                        if (err) { callback(err); return; }\r\n                        callback();\r\n                    });\r\n                });\r\n            },\r\n            /**\r\n             * @param {QueryExpression|*} q\r\n             * @param {function(Error=)} callback\r\n             */\r\n            create:function(q, callback) {\r\n                const thisArg = this;\r\n                self.executeInTransaction(function(tr) {\r\n                    thisArg.drop(function(err) {\r\n                        if (err) { tr(err); return; }\r\n                        try {\r\n                            let sql = util.format(\"CREATE VIEW %s AS \",name);\r\n                            const formatter = new SqliteFormatter();\r\n                            sql += formatter.format(q);\r\n                            self.execute(sql, undefined, tr);\r\n                        }\r\n                        catch(e) {\r\n                            tr(e);\r\n                        }\r\n                    });\r\n                }, function(err) {\r\n                    callback(err);\r\n                });\r\n\r\n            }\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Executes a query against the underlying database\r\n     * @param query {QueryExpression|string|*}\r\n     * @param values {*=}\r\n     * @param {function(Error=,*=)} callback\r\n     */\r\n    execute(query, values, callback) {\r\n        const self = this;\r\n        let sql = null;\r\n        try {\r\n\r\n            if (typeof query === 'string') {\r\n                //get raw sql statement\r\n                sql = query;\r\n            }\r\n            else {\r\n                //format query expression or any object that may be act as query expression\r\n                const formatter = new SqliteFormatter();\r\n                sql = formatter.format(query);\r\n            }\r\n            //validate sql statement\r\n            if (typeof sql !== 'string') {\r\n                callback.call(self, new Error('The executing command is of the wrong type or empty.'));\r\n                return;\r\n            }\r\n            //ensure connection\r\n            self.open(function(err) {\r\n                if (err) {\r\n                    callback.call(self, err);\r\n                }\r\n                else {\r\n                    //log statement (optional)\r\n                    if (process.env.NODE_ENV==='development')\r\n                        TraceUtils.log(util.format('SQL:%s, Parameters:%s', sql, JSON.stringify(values)));\r\n\r\n                    //prepare statement - the traditional way\r\n                    const prepared = self.prepare(sql, values);\r\n\r\n                    let fn;\r\n                    //validate statement\r\n                    if (/^(SELECT|PRAGMA)/ig.test(prepared)) {\r\n                        //prepare for select\r\n                        fn = self.rawConnection.all;\r\n                    }\r\n                    else {\r\n                        //otherwise prepare for run\r\n                        fn = self.rawConnection.run;\r\n                    }\r\n                    //execute raw command\r\n                    fn.call(self.rawConnection, prepared, [] , function(err, result) {\r\n                        if (err) {\r\n                            //log sql\r\n                            TraceUtils.log(util.format('SQL Error:%s', prepared));\r\n                            callback(err);\r\n                        }\r\n                        else {\r\n                            if (result) {\r\n                                if (typeof result === 'object') {\r\n                                    let keys;\r\n                                    if (util.isArray(result)) {\r\n                                        if (result.length>0) {\r\n                                            keys = Object.keys(result[0]);\r\n                                            result.forEach(function(x) {\r\n                                                keys.forEach(function(y) {\r\n                                                    if (x[y] === null) { delete x[y]; }\r\n                                                });\r\n                                            });\r\n                                        }\r\n                                    }\r\n                                    else {\r\n                                        keys = Object.keys(result);\r\n                                        keys.forEach(function(y) {\r\n                                            if (result[y] === null) { delete result[y]; }\r\n                                        });\r\n                                    }\r\n                                }\r\n                                return callback(null, result);\r\n                            }\r\n                            else {\r\n                                return callback();\r\n                            }\r\n\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n        catch (e) {\r\n            callback.call(self, e);\r\n        }\r\n    }\r\n\r\n    lastIdentity(callback) {\r\n        const self = this;\r\n        self.open(function(err) {\r\n            if (err) {\r\n                callback(err);\r\n            }\r\n            else {\r\n                //execute lastval (for sequence)\r\n                self.execute('SELECT last_insert_rowid() as lastval', [], function(err, lastval) {\r\n                    if (err) {\r\n                        callback(null, { insertId: null });\r\n                    }\r\n                    else {\r\n                        lastval = lastval || [];\r\n                        if (lastval.length>0)\r\n                            callback(null, { insertId:lastval[0].lastval });\r\n                        else\r\n                            callback(null, { insertId: null });\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    indexes(table) {\r\n        const self = this, formatter = new SqliteFormatter();\r\n        return {\r\n            list: function (callback) {\r\n                const this1 = this;\r\n                if (this1.hasOwnProperty('indexes_')) {\r\n                    return callback(null, this1['indexes_']);\r\n                }\r\n                self.execute(util.format('PRAGMA INDEX_LIST(`%s`)', table), null , function (err, result) {\r\n                    if (err) { return callback(err); }\r\n                    const indexes = result.filter(function(x) {\r\n                        return x.origin === 'c';\r\n                    }).map(function(x) {\r\n                        return {\r\n                            name:x.name,\r\n                            columns:[]\r\n                        };\r\n                    });\r\n                    async.eachSeries(indexes, function(index, cb) {\r\n                        self.execute(util.format('PRAGMA INDEX_INFO(`%s`)', index.name), function(err, columns) {\r\n                           if (err) { return cb(err); }\r\n                            index.columns = columns.map(function(x) {\r\n                                return x.name;\r\n                            });\r\n                        });\r\n                    }, function(err) {\r\n                        if (err) {\r\n                            return callback(err);\r\n                        }\r\n                        this1['indexes_'] = indexes;\r\n                        return callback(null, indexes);\r\n                    });\r\n                });\r\n            },\r\n            /**\r\n             * @param {string} name\r\n             * @param {Array|string} columns\r\n             * @param {Function} callback\r\n             */\r\n            create: function(name, columns, callback) {\r\n                const cols = [];\r\n                if (typeof columns === 'string') {\r\n                    cols.push(columns)\r\n                }\r\n                else if (util.isArray(columns)) {\r\n                    cols.push.apply(cols, columns);\r\n                }\r\n                else {\r\n                    return callback(new Error(\"Invalid parameter. Columns parameter must be a string or an array of strings.\"));\r\n                }\r\n\r\n                const thisArg = this;\r\n                thisArg.list(function(err, indexes) {\r\n                    if (err) { return callback(err); }\r\n                    const ix = indexes.find(function(x) { return x.name === name; });\r\n                    //format create index SQL statement\r\n                    const sqlCreateIndex = util.format(\"CREATE INDEX %s ON %s(%s)\",\r\n                        formatter.escapeName(name),\r\n                        formatter.escapeName(table),\r\n                        cols.map(function(x) {\r\n                            return formatter.escapeName(x)\r\n                        }).join(\",\"));\r\n                    if (typeof ix === 'undefined' || ix === null) {\r\n                        self.execute(sqlCreateIndex, [], callback);\r\n                    }\r\n                    else {\r\n                        let nCols = cols.length;\r\n                        //enumerate existing columns\r\n                        ix.columns.forEach(function(x) {\r\n                            if (cols.indexOf(x)>=0) {\r\n                                //column exists in index\r\n                                nCols -= 1;\r\n                            }\r\n                        });\r\n                        if (nCols>0) {\r\n                            //drop index\r\n                            thisArg.drop(name, function(err) {\r\n                                if (err) { return callback(err); }\r\n                                //and create it\r\n                                self.execute(sqlCreateIndex, [], callback);\r\n                            });\r\n                        }\r\n                        else {\r\n                            //do nothing\r\n                            return callback();\r\n                        }\r\n                    }\r\n                });\r\n\r\n\r\n            },\r\n            drop: function(name, callback) {\r\n                if (typeof name !== 'string') {\r\n                    return callback(new Error(\"Name must be a valid string.\"));\r\n                }\r\n                self.execute(util.format('PRAGMA INDEX_LIST(`%s`)', table), null, function(err, result) {\r\n                    if (err) { return callback(err); }\r\n                    const exists = typeof result.find(function(x) { return x.name===name; }) !== 'undefined';\r\n                    if (!exists) {\r\n                        return callback();\r\n                    }\r\n                    self.execute(util.format(\"DROP INDEX %s\", self.escapeName(name)), [], callback);\r\n                });\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction zeroPad(number, length) {\r\n    number = number || 0;\r\n    let res = number.toString();\r\n    while (res.length < length) {\r\n        res = '0' + res;\r\n    }\r\n    return res;\r\n}\r\n\r\n/**\r\n * @augments {SqlFormatter}\r\n */\r\nexport class SqliteFormatter extends SqlFormatter {\r\n    /**\r\n     * @constructor\r\n     */\r\n    constructor() {\r\n        super();\r\n        this.settings = {\r\n            nameFormat:SqliteFormatter.NAME_FORMAT,\r\n            forceAlias:true\r\n        };\r\n    }\r\n\r\n    escapeName(name) {\r\n        if (typeof name === 'string')\r\n            return name.replace(/(\\w+)/ig, this.settings.nameFormat);\r\n        return name;\r\n    }\r\n\r\n    /**\r\n     * Escapes an object or a value and returns the equivalent sql value.\r\n     * @param {*} value - A value that is going to be escaped for SQL statements\r\n     * @param {boolean=} unquoted - An optional value that indicates whether the resulted string will be quoted or not.\r\n     * returns {string} - The equivalent SQL string value\r\n     */\r\n    escape(value, unquoted) {\r\n        if (typeof value === 'boolean') { return value ? '1' : '0'; }\r\n        if (value instanceof Date) {\r\n            return this.escapeDate(value);\r\n        }\r\n        let res = super.escape.bind(this)(value, unquoted);\r\n        if (typeof value === 'string') {\r\n            if (REGEXP_SINGLE_QUOTE.test(res))\r\n            //escape single quote (that is already escaped)\r\n                res = res.replace(/\\\\'/g, SINGLE_QUOTE_ESCAPE);\r\n            if (REGEXP_DOUBLE_QUOTE.test(res))\r\n            //escape double quote (that is already escaped)\r\n                res = res.replace(/\\\\\"/g, DOUBLE_QUOTE_ESCAPE);\r\n            if (REGEXP_SLASH.test(res))\r\n            //escape slash (that is already escaped)\r\n                res = res.replace(/\\\\\\\\/g, SLASH_ESCAPE);\r\n        }\r\n        return res;\r\n    }\r\n\r\n    /**\r\n     * @param {Date|*} val\r\n     * @returns {string}\r\n     */\r\n    escapeDate(val) {\r\n        const year   = val.getFullYear();\r\n        const month  = zeroPad(val.getMonth() + 1, 2);\r\n        const day    = zeroPad(val.getDate(), 2);\r\n        const hour   = zeroPad(val.getHours(), 2);\r\n        const minute = zeroPad(val.getMinutes(), 2);\r\n        const second = zeroPad(val.getSeconds(), 2);\r\n        const millisecond = zeroPad(val.getMilliseconds(), 3);\r\n        //format timezone\r\n        const offset = val.getTimezoneOffset(), timezone = (offset<=0 ? '+' : '-') + zeroPad(-Math.floor(offset/60),2) + ':' + zeroPad(offset%60,2);\r\n        return \"'\" + year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second + \".\" + millisecond + timezone + \"'\";\r\n    }\r\n\r\n    /**\r\n     * Implements indexOf(str,substr) expression formatter.\r\n     * @param {string} p0 The source string\r\n     * @param {string} p1 The string to search for\r\n     * @returns {string}\r\n     */\r\n    $indexof(p0, p1) {\r\n        return util.format('(INSTR(%s,%s)-1)', this.escape(p0), this.escape(p1));\r\n    }\r\n\r\n    /**\r\n     * Implements indexOf(str,substr) expression formatter.\r\n     * @param {string} p0 The source string\r\n     * @param {string} p1 The string to search for\r\n     * @returns {string}\r\n     */\r\n    $indexOf(p0, p1) {\r\n        return util.format('(INSTR(%s,%s)-1)', this.escape(p0), this.escape(p1));\r\n    }\r\n\r\n    /**\r\n     * Implements contains(a,b) expression formatter.\r\n     * @param {*} p0 The source string\r\n     * @param {*} p1 The string to search for\r\n     * @returns {string}\r\n     */\r\n    $text(p0, p1) {\r\n        return util.format('(INSTR(%s,%s)-1)>=0', this.escape(p0), this.escape(p1));\r\n    }\r\n\r\n    /**\r\n     * Implements simple regular expression formatter. Important Note: SQLite 3 does not provide a core sql function for regular expression matching.\r\n     * @param {*} p0 The source string or field\r\n     * @param {*} p1 The string to search for\r\n     */\r\n    $regex(p0, p1) {\r\n        //escape expression\r\n        let s1 = this.escape(p1, true);\r\n        //implement starts with equivalent for LIKE T-SQL\r\n        if (/^\\^/.test(s1)) {\r\n            s1 = s1.replace(/^\\^/,'');\r\n        }\r\n        else {\r\n            s1 = '%' + s1;\r\n        }\r\n        //implement ends with equivalent for LIKE T-SQL\r\n        if (/\\$$/.test(s1)) {\r\n            s1 = s1.replace(/\\$$/,'');\r\n        }\r\n        else {\r\n            s1 += '%';\r\n        }\r\n        return util.format('LIKE(\\'%s\\',%s) >= 1',s1, this.escape(p0));\r\n    }\r\n\r\n    /**\r\n     * Implements concat(a,b) expression formatter.\r\n     * @param {*} p0\r\n     * @param {*} p1\r\n     * @returns {string}\r\n     */\r\n    $concat(p0, p1) {\r\n        return util.format('(IFNULL(%s,\\'\\') || IFNULL(%s,\\'\\'))', this.escape(p0),  this.escape(p1));\r\n    }\r\n\r\n    /**\r\n     * Implements substring(str,pos) expression formatter.\r\n     * @param {String} p0 The source string\r\n     * @param {Number} pos The starting position\r\n     * @param {Number=} length The length of the resulted string\r\n     * @returns {string}\r\n     */\r\n    $substring(p0, pos, length) {\r\n        if (length)\r\n            return util.format('SUBSTR(%s,%s,%s)', this.escape(p0), pos.valueOf()+1, length.valueOf());\r\n        else\r\n            return util.format('SUBSTR(%s,%s)', this.escape(p0), pos.valueOf()+1);\r\n    }\r\n\r\n    /**\r\n     * Implements substring(str,pos) expression formatter.\r\n     * @param {String} p0 The source string\r\n     * @param {Number} pos The starting position\r\n     * @param {Number=} length The length of the resulted string\r\n     * @returns {string}\r\n     */\r\n    $substr(p0, pos, length) {\r\n        if (length)\r\n            return util.format('SUBSTR(%s,%s,%s)', this.escape(p0), pos.valueOf()+1, length.valueOf());\r\n        else\r\n            return util.format('SUBSTR(%s,%s)', this.escape(p0), pos.valueOf()+1);\r\n    }\r\n\r\n    /**\r\n     * Implements length(a) expression formatter.\r\n     * @param {*} p0\r\n     * @returns {string}\r\n     */\r\n    $length(p0) {\r\n        return util.format('LENGTH(%s)', this.escape(p0));\r\n    }\r\n\r\n    $ceiling(p0) {\r\n        return util.format('CEIL(%s)', this.escape(p0));\r\n    }\r\n\r\n    $startswith(p0, p1) {\r\n        //validate params\r\n        if (_.isNil(p0) || _.isNil(p1))\r\n            return '';\r\n        return 'LIKE(\\'' + this.escape(p1, true) + '%\\',' + this.escape(p0) + ')';\r\n    }\r\n\r\n    $contains(p0, p1) {\r\n        //validate params\r\n        if (_.isNil(p0) || _.isNil(p1))\r\n            return '';\r\n        return 'LIKE(\\'%' + this.escape(p1, true) + '%\\',' + this.escape(p0) + ')';\r\n    }\r\n\r\n    $endswith(p0, p1) {\r\n        //validate params\r\n        if (_.isNil(p0) || _.isNil(p1))\r\n            return '';\r\n        return 'LIKE(\\'%' + this.escape(p1, true) + '\\',' + this.escape(p0) + ')';\r\n    }\r\n\r\n    $day(p0) { return 'CAST(strftime(\\'%d\\', ' + this.escape(p0) + ') AS INTEGER)'; }\r\n    $dayOfMonth(p0) { return 'CAST(strftime(\\'%d\\', ' + this.escape(p0) + ') AS INTEGER)'; }\r\n    $month(p0) { return 'CAST(strftime(\\'%m\\', ' + this.escape(p0) + ') AS INTEGER)'; }\r\n    $year(p0) { return 'CAST(strftime(\\'%Y\\', ' + this.escape(p0) + ') AS INTEGER)'; }\r\n    $hour(p0) { return 'CAST(strftime(\\'%H\\', ' + this.escape(p0) + ') AS INTEGER)'; }\r\n    $minute(p0) { return 'CAST(strftime(\\'%M\\', ' + this.escape(p0) + ') AS INTEGER)'; }\r\n    $second(p0) { return 'CAST(strftime(\\'%S\\', ' + this.escape(p0) + ') AS INTEGER)'; }\r\n    $date(p0) { return 'date(' + this.escape(p0) + ')'; }\r\n}\r\n\r\nSqliteFormatter.NAME_FORMAT = '`$1`';\r\n\r\nconst REGEXP_SINGLE_QUOTE=/\\\\'/g, SINGLE_QUOTE_ESCAPE ='\\'\\'',\r\n    REGEXP_DOUBLE_QUOTE=/\\\\\"/g, DOUBLE_QUOTE_ESCAPE = '\"',\r\n    REGEXP_SLASH=/\\\\\\\\/g, SLASH_ESCAPE = '\\\\';\r\n\r\n/**\r\n * Creates an instance of SqliteAdapter object that represents a SQLite database connection.\r\n * @param {*} options An object that represents the properties of the underlying database connection.\r\n * @returns {*}\r\n */\r\nexport function createInstance(options) {\r\n    return new SqliteAdapter(options);\r\n}\r\n"]}