{"version":3,"sources":["index.es6"],"names":["createInstance","oracledb","async","util","_","SqlFormatter","TraceUtils","SqlUtils","OracleAdapter","options","host","rawConnection","connectString","Object","defineProperty","get","port","service","type","instance","callback","self","getConnection","user","password","err","connection","release","process","env","NODE_ENV","log","message","stack","e","query","values","prepare","fn","open","transaction","call","rollback","commit","name","view","create","obj","migration","format","result","test","replace","formatType","waterfall","cb","supportMigrations","table","exists","arg","eachSeries","s","cb0","execute","appliesTo","version","add","column","newType","oldType","isArray","remove","length","Error","change","columns","x","i","find","y","primary","splice","precision","scale","toUpperCase","toString","nullable","size","push","targetTable","model","description","entity","attribute","selectIdentity","batch","owner","matches","exec","schema","sql","count","hasSequence","fields","strFields","map","filter","oneToMany","join","strTable","formatter","OracleFormatter","escapeName","strPKFields","drop","undefined","q","thisArg","executeInTransaction","tr","$fixed","JSON","stringify","prepared","outFormat","OBJECT","autoCommit","rows","field","parseInt","concat","zeroPad","number","res","settings","nameFormat","NAME_FORMAT","forceAlias","value","unquoted","Date","escapeDate","bind","SINGLE_QUOTE_ESCAPE","DOUBLE_QUOTE_ESCAPE","SLASH_ESCAPE","val","year","getFullYear","month","getMonth","day","getDate","hour","getHours","minute","getMinutes","second","getSeconds","offset","getTimezoneOffset","timezone","Math","floor","getMilliseconds","formatSelect","$take","$skip","p0","p1","escape","pos","valueOf","isNil"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @license\n * MOST Web Framework 2.0 Codename Blueshift\n * Copyright (c) 2014, Kyriakos Barbounakis k.barbounakis@gmail.com\n *                     Anthi Oikonomou anthioikonomou@gmail.com\n *\n * Use of this source code is governed by an BSD-3-Clause license that can be\n * found in the LICENSE file at https://themost.io/license\n */\nimport oracledb from 'oracledb';\nimport async from 'async';\nimport util from 'util';\nimport _ from 'lodash';\nimport {SqlFormatter} from '@themost/query/formatter';\nimport {TraceUtils} from \"@themost/common/utils\";\nimport {SqlUtils} from \"@themost/query/utils\";\n\n/**\n * @class\n * @augments DataAdapter\n * @property {string} connectString\n */\nexport class OracleAdapter {\n    /**\n     * @constructor\n     * @param {*} options\n     */\n    constructor(options) {\n        this.options = options || { host:'localhost' };\n        /**\n         * Represents the database raw connection associated with this adapter\n         * @type {*}\n         */\n        this.rawConnection = null;\n        let connectString;\n        //of options contains connectString parameter ignore all other params and define this as the database connection string\n        if (options.connectString) { connectString = options.connectString; }\n        Object.defineProperty(this, 'connectString', {\n            get: function() {\n                if (typeof connectString === 'string') {\n                    return connectString;\n                }\n                else {\n                    //generate connectString ([//]host_name[:port][/service_name][:server_type][/instance_name])\n                    //get hostname or localhost\n                    connectString = options.host || 'localhost';\n                    //append port\n                    if (typeof options.port !== 'undefined') { connectString += ':' + options.port; }\n                    if (typeof options.service !== 'undefined') { connectString += '/' + options.service; }\n                    if (typeof options.type !== 'undefined') { connectString += ':' + options.type; }\n                    if (typeof options.instance !== 'undefined') { connectString += '/' + options.instance; }\n                    return connectString;\n                }\n            }\n        });\n    }\n\n    open(callback) {\n        const self = this;\n        callback = callback || function() {};\n        if (self.rawConnection) {\n            callback();\n        }\n        else {\n            oracledb.getConnection(\n                {\n                    user          : this.options.user,\n                    password      : this.options.password,\n                    connectString : this.connectString\n                }, function(err, connection) {\n                    if (err) { return callback(err); }\n                    self.rawConnection = connection;\n                    callback();\n                });\n        }\n    }\n\n    close(callback) {\n        const self = this;\n        callback = callback || function() {};\n        try {\n            if (self.rawConnection)\n            {\n                //close connection\n                self.rawConnection.release(function(err) {\n                    if (process.env.NODE_ENV === 'development') {\n                        TraceUtils.log('An error occured while closing database.');\n                        TraceUtils.log(err.message);\n                        if (err.stack) { TraceUtils.log(err.stack); }\n                    }\n                    //and finally return\n                    callback();\n                });\n            }\n            else {\n                callback();\n            }\n\n        }\n        catch (e) {\n            TraceUtils.log('An error occured while closing database.');\n            TraceUtils.log(e.message);\n            //call callback without error\n            callback();\n        }\n    }\n\n    /**\n     * @param {string} query\n     * @param {*=} values\n     */\n    prepare(query, values) {\n        return SqlUtils.prepare(query,values);\n    }\n\n    static formatType(field) {\n        const size = parseInt(field.size);\n        let s;\n        switch (field.type)\n        {\n            case 'Boolean':\n                s = 'NUMBER(1,0)';\n                break;\n            case 'Byte':\n                s = 'NUMBER(3,0)';\n                break;\n            case 'Number':\n                s = 'NUMBER(38)';\n                break;\n            case 'Float':\n                s = 'NUMBER(19,4)';\n                break;\n            case 'Counter':\n                return 'NUMBER(19,0)';\n            case 'Currency':\n                s =  'NUMBER(' + (field.size || 19) + ',4)';\n                break;\n            case 'Decimal':\n                s =  'NUMBER';\n                if ((field.size) && (field.scale)) {\n                    s += '(' + field.size + ',' + field.scale + ')';\n                }\n                else {\n                    s += '(19,4)';\n                }\n                break;\n            case 'Date':\n            case 'DateTime':\n                s = 'TIMESTAMP(6) WITH LOCAL TIME ZONE';\n                break;\n            case 'Time':\n                s = 'NUMBER(19,4)';\n                break;\n            case 'Long':\n            case 'Duration':\n                s = 'NUMBER(19,0)';\n                break;\n            case 'Integer':\n                s = 'NUMBER' + (field.size ? '(' + field.size + ',0)':'(19,0)' );\n                break;\n            case 'URL':\n            case 'Text':\n            case 'Note':\n                s =field.size ? util.format('NVARCHAR2(%s)', field.size) : 'NVARCHAR2(255)';\n                break;\n            case 'Image':\n            case 'Binary':\n                s ='LONG RAW';\n                break;\n            case 'Guid':\n                s = 'VARCHAR2(36)';\n                break;\n            case 'Short':\n                s = 'NUMBER(5,0)';\n                break;\n            default:\n                s = 'NUMBER(19,0)';\n                break;\n        }\n        if (field.primary) {\n            return s.concat(' NOT NULL');\n        }\n        else {\n            return s.concat((typeof field.nullable=== 'undefined' || field.nullable === null) ? ' NULL': (field.nullable ? ' NULL': ' NOT NULL'));\n        }\n    }\n\n    /**\n     * Begins a transactional operation by executing the given function\n     * @param fn {function} The function to execute\n     * @param callback {function(Error=)} The callback that contains the error -if any- and the results of the given operation\n     */\n    executeInTransaction(fn, callback) {\n        const self = this;\n        //ensure parameters\n        fn = fn || function() {}; callback = callback || function() {};\n        self.open(function(err) {\n            if (err) {\n                callback(err);\n            }\n            else {\n                if (self.transaction) {\n                    fn.call(self, function(err) {\n                        callback(err);\n                    });\n                }\n                else {\n                    //initialize dummy transaction object (for future use)\n                    self.transaction = { };\n                    //execute function\n                    fn.call(self, function(err) {\n                        if (err) {\n                            //rollback transaction\n                            self.rawConnection.rollback(function() {\n                                delete self.transaction;\n                                callback(err);\n                            });\n                        }\n                        else {\n                            //commit transaction\n                            self.rawConnection.commit(function(err) {\n                                delete self.transaction;\n                                callback(err);\n                            });\n                        }\n                    });\n                }\n            }\n        });\n    }\n\n    /**\n     *\n     * @param {string} name\n     * @param {QueryExpression|*} query\n     * @param {function(Error=)} callback\n     */\n    createView(name, query, callback) {\n        this.view(name).create(query, callback);\n    }\n\n    /*\n     * @param {DataModelMigration|*} obj An Object that represents the data model scheme we want to migrate\n     * @param {function(Error=)} callback\n     */\n    migrate(obj, callback) {\n        const self = this;\n        callback = callback || function() {};\n        if (typeof obj === 'undefined' || obj === null) { callback(); return; }\n        /**\n         * @type {DataModelMigration|*}\n         */\n        const migration = obj;\n\n        const format = function(format, obj)\n        {\n            let result = format;\n            if (/%t/.test(format))\n                result = result.replace(/%t/g,OracleAdapter.formatType(obj));\n            if (/%f/.test(format))\n                result = result.replace(/%f/g,obj.name);\n            return result;\n        };\n\n\n        async.waterfall([\n            //1. Check migrations table existence\n            function(cb) {\n                if (OracleAdapter.supportMigrations) {\n                    cb(null, true);\n                    return;\n                }\n                self.table('migrations').exists(function(err, exists) {\n                    if (err) { cb(err); return; }\n                    cb(null, exists);\n                });\n            },\n            //2. Create migrations table, if it does not exist\n            function(arg, cb) {\n                if (arg) { cb(null, 0); return; }\n                //create migrations table\n\n                async.eachSeries([\n                    'CREATE TABLE \"migrations\"(\"id\" NUMBER(10) NOT NULL, \"appliesTo\" NVARCHAR2(255) NOT NULL, \"model\" NVARCHAR2(255) NULL, ' +\n                    '\"description\" NVARCHAR2(255),\"version\" NVARCHAR2(24) NOT NULL, CONSTRAINT \"migrations_pk\" PRIMARY KEY (\"id\"))',\n                    'CREATE SEQUENCE \"migrations_id_seq\" START WITH 1 INCREMENT BY 1'\n                ], function(s, cb0) {\n                    self.execute(s, [], cb0);\n                }, function(err) {\n                    if (err) { return cb(err); }\n                    OracleAdapter.supportMigrations=true;\n                    return cb(null, 0);\n                });\n\n                //self.execute('CREATE TABLE \"migrations\"(\"id\" NUMBER(10) NOT NULL, ' +\n                //    '\"appliesTo\" NVARCHAR2(255) NOT NULL, \"model\" NVARCHAR2(255) NULL, ' +\n                //    '\"description\" NVARCHAR2(255),\"version\" NVARCHAR2(24) NOT NULL, ' +\n                //    'CONSTRAINT \"migrations_pk\" PRIMARY KEY (\"id\")); ' +\n                //    'CREATE SEQUENCE \"migrations_seq\" START WITH 1 INCREMENT BY 1; ' +\n                //    'CREATE TRIGGER \"migrations_auto_inc\" BEFORE INSERT ON \"migrations\" FOR EACH ROW BEGIN :new.\"id\" := \"migrations_seq\".nextval; END;',\n                //    [], function(err) {\n                //        if (err) { cb(err); return; }\n                //        OracleAdapter.supportMigrations=true;\n                //        cb(null, 0);\n                //    });\n            },\n            //3. Check if migration has already been applied (true=Table version is equal to migration version, false=Table version is older from migration version)\n            function(arg, cb) {\n                self.table(migration.appliesTo).version(function(err, version) {\n                    if (err) { cb(err); return; }\n                    cb(null, (version>=migration.version));\n                });\n            },\n            //4a. Check table existence (-1=Migration has already been applied, 0=Table does not exist, 1=Table exists)\n            function(arg, cb) {\n                //migration has already been applied (set migration.updated=true)\n                if (arg) {\n                    migration['updated']=true;\n                    cb(null, -1);\n                }\n                else {\n                    self.table(migration.appliesTo).exists(function(err, exists) {\n                        if (err) { cb(err); return; }\n                        cb(null, exists ? 1 : 0);\n                    });\n                }\n            },\n            //5. Migrate target table (create or alter)\n            function(arg, cb) {\n                //migration has already been applied (args[0]=-1)\n                if (arg < 0) {\n                    cb(null, arg);\n                }\n                else if (arg === 0) {\n                    self.table(migration.appliesTo).create(migration.add, function(err) {\n                        if (err) { return cb(err); }\n                        cb(null, 1);\n                    });\n                }\n                else if (arg === 1) {\n                    let column, newType, oldType;\n\n                    //1. columns to be removed\n                    if (util.isArray(migration.remove)) {\n                        if (migration.remove.length>0) {\n                            return cb(new Error('Data migration remove operation is not supported by this adapter.'));\n                        }\n                    }\n                    //1. columns to be changed\n                    if (util.isArray(migration.change)) {\n                        if (migration.change.length>0) {\n                            return cb(new Error('Data migration change operation is not supported by this adapter. Use add collection instead.'));\n                        }\n                    }\n\n                    if (util.isArray(migration.add)) {\n                        //init change collection\n                        migration.change = [];\n                        //get table columns\n                        self.table(migration.appliesTo).columns(function(err, columns) {\n                            if (err) { return cb(err); }\n                            for (let i = 0; i < migration.add.length; i++) {\n                                const x = migration.add[i];\n                                column = _.find(columns, function(y) {\n                                    return y.name === x.name;\n                                });\n                                if (column) {\n                                    //if column is primary key remove it from collection\n                                    if (column.primary) {\n                                        migration.add.splice(i, 1);\n                                        i-=1;\n                                    }\n                                    else {\n                                        newType = format('%t', x);\n                                        if (column.precision !== null && column.scale !== null) {\n                                            oldType = util.format('%s(%s,%s) %s', column.type.toUpperCase(), column.precision.toString(), column.scale.toString(), (column.nullable ? 'NULL' : 'NOT NULL'));\n                                        }\n                                        else if (/^TIMESTAMP\\(\\d+\\) WITH LOCAL TIME ZONE$/i.test(column.type)) {\n                                            oldType=util.format('%s %s', column.type.toUpperCase(), (column.nullable ? 'NULL' : 'NOT NULL'));\n                                        }\n                                        else if (column.size !== null) {\n                                            oldType = util.format('%s(%s) %s', column.type.toUpperCase(), column.size.toString(), (column.nullable ? 'NULL' : 'NOT NULL'));\n                                        }\n                                        else {\n                                            oldType = util.format('%s %s', column.type.toUpperCase(), (column.nullable ? 'NULL' : 'NOT NULL'));\n                                        }\n                                        //remove column from collection\n                                        migration.add.splice(i, 1);\n                                        i-=1;\n                                        if (newType !== oldType) {\n                                            //add column to alter collection\n                                            migration.change.push(x);\n                                        }\n                                    }\n                                }\n                            }\n                            //alter table\n                            const targetTable = self.table(migration.appliesTo);\n                            //add new columns (if any)\n                            targetTable.add(migration.add, function(err) {\n                                if (err) { return cb(err); }\n                                //modify columns (if any)\n                                targetTable.change(migration.change, function(err) {\n                                    if (err) { return cb(err); }\n                                    cb(null, 1);\n                                });\n                            });\n                        });\n                    }\n                    else {\n                        cb(new Error('Invalid migration data.'));\n                    }\n                }\n                else {\n                    cb(new Error('Invalid table status.'));\n                }\n            },\n            function(arg, cb) {\n                if (arg>0) {\n                    //log migration to database\n                    self.execute('INSERT INTO \"migrations\"(\"id\",\"appliesTo\", \"model\", \"version\", \"description\") VALUES (\"migrations_id_seq\".nextval,?,?,?,?)', [migration.appliesTo,\n                        migration.model,\n                        migration.version,\n                        migration.description ], function(err) {\n                        if (err)  {\n                            return cb(err);\n                        }\n                        cb(null, 1);\n                    });\n                }\n                else {\n                    migration['updated'] = true;\n                    cb(null, arg);\n                }\n            }\n        ], function(err) {\n            callback(err);\n        });\n\n    }\n\n    /**\n     * Produces a new identity value for the given entity and attribute.\n     * @param entity {String} The target entity name\n     * @param attribute {String} The target attribute\n     * @param callback {Function=}\n     */\n    selectIdentity(entity, attribute, callback) {\n\n        const self = this;\n        //format sequence name ([entity]_[attribute]_seg e.g. user_id_seq)\n        const name = entity + \"_\" + attribute + \"_seq\";\n        //search for sequence\n        self.execute('SELECT SEQUENCE_OWNER,SEQUENCE_NAME FROM ALL_SEQUENCES WHERE \"SEQUENCE_NAME\" = ?', [name], function(err, result) {\n            if (err) { return callback(err); }\n            if (result.length===0) {\n                self.execute(util.format('CREATE SEQUENCE \"%s\" START WITH 1 INCREMENT BY 1', name), [], function(err) {\n                    if (err) { return callback(err); }\n                    //get next value\n                    self.execute(util.format('SELECT \"%s\".nextval AS \"resultId\" FROM DUAL', name), [], function(err, result) {\n                        if (err) { return callback(err); }\n                        callback(null, result[0]['resultId']);\n                    });\n                });\n            }\n            else {\n                //get next value\n                self.execute(util.format('SELECT \"%s\".nextval AS \"resultId\" FROM DUAL', name), [], function(err, result) {\n                    if (err) { return callback(err); }\n                    callback(null, result[0]['resultId']);\n                });\n            }\n        });\n    }\n\n    /**\n     * Produces a new counter auto increment value for the given entity and attribute.\n     * @param entity {String} The target entity name\n     * @param attribute {String} The target attribute\n     * @param callback {Function=}\n     */\n    nextIdentity(entity, attribute, callback) {\n        this.selectIdentity(entity, attribute , callback);\n    }\n\n    /**\n     * Executes an operation against database and returns the results.\n     * @param {*} batch\n     * @param {function(Error=)} callback\n     */\n    executeBatch(batch, callback) {\n        callback = callback || function() {};\n        callback(new Error('DataAdapter.executeBatch() is obsolete. Use DataAdapter.executeInTransaction() instead.'));\n    }\n\n    table(name) {\n        const self = this;\n        let owner;\n        let table;\n        const matches = /(\\w+)\\.(\\w+)/.exec(name);\n        if (matches) {\n            //get schema owner (the first part of the string provided)\n            owner = matches[1];\n            //get table name (the second part of the string provided)\n            table = matches[2];\n        }\n        else {\n            //get table name (the whole string provided)\n            table = name;\n            //get schema name (from options)\n            if (self.options && self.options.schema) {\n                owner = self.options.schema;\n            }\n        }\n\n        const format = function(format, obj)\n        {\n            let result = format;\n            if (/%t/.test(format))\n                result = result.replace(/%t/g,OracleAdapter.formatType(obj));\n            if (/%f/.test(format))\n                result = result.replace(/%f/g,obj.name);\n            return result;\n        };\n\n        return {\n            /**\n             * @param {function(Error,Boolean=)} callback\n             */\n            exists:function(callback) {\n                let sql;\n                if (typeof owner === 'undefined' || owner === null) {\n                    sql = 'SELECT COUNT(*) AS \"count\" FROM ALL_OBJECTS WHERE object_type IN (\\'TABLE\\') AND object_name = ?';\n                }\n                else {\n                    sql = 'SELECT COUNT(*) AS \"count\" FROM ALL_OBJECTS WHERE object_type IN (\\'TABLE\\') AND object_name = ? AND REGEXP_LIKE(owner,?,\\'i\\')';\n                }\n                self.execute(sql, [table, '^' + owner + '$'], function(err, result) {\n                    if (err) { callback(err); return; }\n                    callback(null, (result[0].count>0));\n                });\n            },\n            /**\n             * @param {function(Error,string=)} callback\n             */\n            version:function(callback) {\n                self.execute('SELECT MAX(\"version\") AS \"version\" FROM \"migrations\" WHERE \"appliesTo\"=?',\n                    [name], function(err, result) {\n                        if (err) { return callback(err); }\n                        if (result.length===0)\n                            callback(null, '0.0');\n                        else\n                            callback(null, result[0].version || '0.0');\n                    });\n            },\n            /**\n             * @param {function(Error,Boolean=)} callback\n             */\n            hasSequence:function(callback) {\n                callback = callback || function() {};\n                self.execute('SELECT COUNT(*) AS \"count\" FROM ALL_SEQUENCES WHERE SEQUENCE_NAME=?',\n                    [ table + '_seq' ], function(err, result) {\n                        if (err) { callback(err); return; }\n                        callback(null, (result[0].count>0));\n                    });\n            },\n            /**\n             * @param {function(Error=,Array=)} callback\n             */\n            columns:function(callback) {\n                callback = callback || function() {};\n\n                /*\n                 SELECT c0.COLUMN_NAME AS \"name\", c0.DATA_TYPE AS \"type\", ROWNUM AS \"ordinal\",\n                 c0.DATA_LENGTH AS \"size\", c0.DATA_SCALE AS \"scale\", CASE WHEN c0.NULLABLE='Y'\n                 THEN 1 ELSE 0 END AS \"nullable\", CASE WHEN t0.CONSTRAINT_TYPE='P' THEN 1 ELSE 0 END AS \"primaryKey\"\n                 FROM ALL_TAB_COLUMNS c0 LEFT JOIN (SELECT cols.table_name, cols.column_name, cols.owner, cons.constraint_type\n                 FROM all_constraints cons, all_cons_columns cols WHERE cons.constraint_type = 'P'\n                 AND cons.constraint_name = cols.constraint_name AND cons.owner = cols.owner) t0 ON c0.TABLE_NAME=t0.TABLE_NAME\n                 AND c0.OWNER=t0.OWNER AND c0.COLUMN_NAME=t0.COLUMN_NAME WHERE c0.TABLE_NAME = ?\n                */\n\n                let sql = 'SELECT c0.COLUMN_NAME AS \"name\", c0.DATA_TYPE AS \"type\", ROWNUM AS \"ordinal\", CASE WHEN c0.\"CHAR_LENGTH\">0 THEN c0.\"CHAR_LENGTH\" ELSE c0.DATA_LENGTH END as \"size\", ' +\n                    'c0.DATA_SCALE AS \"scale\", c0.DATA_PRECISION AS \"precision\", CASE WHEN c0.NULLABLE=\\'Y\\' THEN 1 ELSE 0 END AS \"nullable\", CASE WHEN t0.CONSTRAINT_TYPE=\\'P\\' ' +\n                'THEN 1 ELSE 0 END AS \"primary\" FROM ALL_TAB_COLUMNS c0 LEFT JOIN (SELECT cols.table_name, cols.column_name, cols.owner, ' +\n                'cons.constraint_type FROM all_constraints cons, all_cons_columns cols WHERE cons.constraint_type = \\'P\\' ' +\n                'AND cons.constraint_name = cols.constraint_name AND cons.owner = cols.owner) t0 ON c0.TABLE_NAME=t0.TABLE_NAME ' +\n                'AND c0.OWNER=t0.OWNER AND c0.COLUMN_NAME=t0.COLUMN_NAME WHERE c0.TABLE_NAME = ?';\n                if (owner) { \n                    sql += ' AND REGEXP_LIKE(c0.OWNER,?,\\'i\\')'\n                }\n                self.execute(sql, [name, '^' + owner + '$'], function(err, result) {\n                        if (err) { callback(err); return; }\n                        callback(null, result);\n                    });\n            },\n            /**\n             * @param {{name:string,type:string,primary:boolean|number,nullable:boolean|number,size:number, scale:number,precision:number,oneToMany:boolean}[]|*} fields\n             * @param callback\n             */\n            create: function(fields, callback) {\n                callback = callback || function() {};\n                fields = fields || [];\n                if (!util.isArray(fields)) {\n                    return callback(new Error('Invalid argument type. Expected Array.'));\n                }\n                if (fields.length === 0) {\n                    return callback(new Error('Invalid argument. Fields collection cannot be empty.'));\n                }\n                let strFields = _.map(\n                    _.filter(fields, (x) => {\n                        return !x.oneToMany;\n                    }),\n                    (x) => {\n                        return format('\"%f\" %t', x);\n                    }).join(', ');\n\n                //get table qualified name\n                let strTable = '';\n\n                const formatter = new OracleFormatter();\n                if (typeof owner !== 'undefined') { strTable = formatter.escapeName(owner) + \".\"; }\n                strTable += formatter.escapeName(table);\n                //add primary key constraint\n                const strPKFields = _.map(_.find(fields, (x) => { return (x.primary === true || x.primary === 1); }),\n                    (x) => {\n                    return formatter.escapeName(x.name);\n                }).join(', ');\n                if (strPKFields.length>0) {\n                    strFields += ', ' + util.format('CONSTRAINT \"%s_pk\" PRIMARY KEY (%s)', table, strPKFields);\n                }\n                const sql = util.format('CREATE TABLE %s (%s)', strTable, strFields);\n                self.execute(sql, null, function(err) {\n                    callback(err);\n                });\n            },\n            /**\n             * Alters the table by adding an array of fields\n             * @param {{name:string,type:string,primary:boolean|number,nullable:boolean|number,size:number,oneToMany:boolean}[]|*} fields\n             * @param callback\n             */\n            add:function(fields, callback) {\n                callback = callback || function() {};\n                fields = fields || [];\n                if (!util.isArray(fields)) {\n                    //invalid argument exception\n                    return callback(new Error('Invalid argument type. Expected Array.'));\n                }\n                if (fields.length === 0) {\n                    //do nothing\n                    return callback();\n                }\n                const strFields = fields.map(function(x) {\n                    return format('\"%f\" %t', x);\n                }).join(', ');\n\n                //get table qualified name\n                let strTable = '';\n\n                const formatter = new OracleFormatter();\n                if (typeof owner !== 'undefined') { strTable = formatter.escapeName(owner) + \".\"; }\n                strTable += formatter.escapeName(table);\n                //generate SQL statement\n                const sql = util.format('ALTER TABLE %s ADD (%s)', strTable, strFields);\n                self.execute(sql, [], function(err) {\n                    callback(err);\n                });\n            },\n            /**\n             * Alters the table by modifying an array of fields\n             * @param {{name:string,type:string,primary:boolean|number,nullable:boolean|number,size:number,oneToMany:boolean}[]|*} fields\n             * @param callback\n             */\n            change:function(fields, callback) {\n                callback = callback || function() {};\n                fields = fields || [];\n                if (!util.isArray(fields)) {\n                    //invalid argument exception\n                    return callback(new Error('Invalid argument type. Expected Array.'));\n                }\n                if (fields.length === 0) {\n                    //do nothing\n                    return callback();\n                }\n                const strFields = fields.map(function(x) {\n                    return format('\"%f\" %t', x);\n                }).join(', ');\n\n                //get table qualified name\n                let strTable = '';\n\n                const formatter = new OracleFormatter();\n                if (typeof owner !== 'undefined') { strTable = formatter.escapeName(owner) + \".\"; }\n                strTable += formatter.escapeName(table);\n                //generate SQL statement\n                const sql = util.format('ALTER TABLE %s MODIFY (%s)', strTable, strFields);\n                self.execute(sql, [], function(err) {\n                    callback(err);\n                });\n            }\n        };\n    }\n\n    view(name) {\n        const self = this;\n        let owner;\n        let view;\n\n        const matches = /(\\w+)\\.(\\w+)/.exec(name);\n        if (matches) {\n            //get schema owner\n            owner = matches[1];\n            //get table name\n            view = matches[2];\n        }\n        else {\n            view = name;\n        }\n        return {\n            /**\n             * @param {function(Error,Boolean=)} callback\n             */\n            exists:function(callback) {\n                let sql = 'SELECT COUNT(*) AS \"count\" FROM ALL_OBJECTS WHERE object_type IN (\\'VIEW\\') AND object_name = ?';\n                if (typeof owner !== 'undefined') {\n                    sql += ' AND REGEXP_LIKE(owner,?,\\'i\\')';\n                }\n                self.execute(sql, [name, '^' + (owner || '') + '$'], function(err, result) {\n                    if (err) { callback(err); return; }\n                    callback(null, (result[0].count>0));\n                });\n            },\n            /**\n             * @param {function(Error=)} callback\n             */\n            drop:function(callback) {\n                callback = callback || function() {};\n                self.open(function(err) {\n                   if (err) { return callback(err); }\n\n                    let sql = 'SELECT COUNT(*) AS \"count\" FROM ALL_OBJECTS WHERE object_type IN (\\'VIEW\\') AND object_name = ?';\n                    if (typeof owner !== 'undefined') {\n                        sql += ' AND REGEXP_LIKE(owner,?,\\'i\\')';\n                    }\n                    self.execute(sql, [name, '^' + (owner || '') + '$'], function(err, result) {\n                        if (err) { return callback(err); }\n                        const exists = (result[0].count>0);\n                        if (exists) {\n                            const sql = util.format('DROP VIEW \"%s\"',name);\n                            self.execute(sql, undefined, function(err) {\n                                if (err) { callback(err); return; }\n                                callback();\n                            });\n                        }\n                        else {\n                            callback();\n                        }\n                    });\n                });\n            },\n            /**\n             * @param {QueryExpression|*} q\n             * @param {function(Error=)} callback\n             */\n            create:function(q, callback) {\n                const thisArg = this;\n                self.executeInTransaction(function(tr) {\n                    thisArg.drop(function(err) {\n                        if (err) { tr(err); return; }\n                        try {\n                            let sql = util.format('CREATE VIEW \"%s\" AS ',name);\n                            const formatter = new OracleFormatter();\n                            sql += formatter.format(q);\n                            self.execute(sql, [], tr);\n                        }\n                        catch(e) {\n                            tr(e);\n                        }\n                    });\n                }, function(err) {\n                    callback(err);\n                });\n\n            }\n        };\n    }\n\n    /**\n     * Executes a query against the underlying database\n     * @param query {QueryExpression|string|*}\n     * @param values {*=}\n     * @param {function(Error=,*=)} callback\n     */\n    execute(query, values, callback) {\n        const self = this;\n        let sql = null;\n        try {\n\n            if (typeof query === 'string') {\n                //get raw sql statement\n                sql = query;\n            }\n            else {\n                //format query expression or any object that may be act as query expression\n                const formatter = new OracleFormatter();\n                sql = formatter.format(query);\n                //if query is fixed (an SQL expression without any table definition)\n                if (query.$fixed === true) {\n                    //use dymmy oracle table DUAL\n                    sql += ' FROM DUAL';\n                }\n            }\n            //validate sql statement\n            if (typeof sql !== 'string') {\n                callback.call(self, new Error('The executing command is of the wrong type or empty.'));\n                return;\n            }\n            //ensure connection\n            self.open(function(err) {\n                if (err) {\n                    callback.call(self, err);\n                }\n                else {\n                    //log statement (optional)\n                    if (process.env.NODE_ENV==='development')\n                        TraceUtils.log(util.format('SQL:%s, Parameters:%s', sql, JSON.stringify(values)));\n                    //prepare statement - the traditional way\n                    const prepared = self.prepare(sql, values);\n                    //execute raw command\n                    self.rawConnection.execute(prepared,[], {outFormat: oracledb.OBJECT, autoCommit: (typeof self.transaction === 'undefined') }, function(err, result) {\n                        if (err) {\n                            //log sql\n                            TraceUtils.log(util.format('SQL Error:%s', prepared));\n                            callback(err);\n                        }\n                        else {\n                            if (result)\n                                callback(null, result.rows);\n                            else\n                                callback();\n                        }\n                    });\n                }\n            });\n        }\n        catch (e) {\n            callback.call(self, e);\n        }\n    }\n}\n\nfunction zeroPad(number, length) {\n    number = number || 0;\n    let res = number.toString();\n    while (res.length < length) {\n        res = '0' + res;\n    }\n    return res;\n}\n\n/**\n * @class\n * @augments {SqlFormatter}\n */\nexport class OracleFormatter extends SqlFormatter {\n    /**\n     * @constructor\n     */\n    constructor() {\n        super();\n        this.settings = {\n            nameFormat:OracleFormatter.NAME_FORMAT,\n            forceAlias:true\n        };\n    }\n\n    escapeName(name) {\n        if (typeof name === 'string')\n            return name.replace(/(\\w+)/ig, this.settings.nameFormat);\n        return name;\n    }\n\n    /**\n     * Escapes an object or a value and returns the equivalent sql value.\n     * @param {*} value - A value that is going to be escaped for SQL statements\n     * @param {boolean=} unquoted - An optional value that indicates whether the resulted string will be quoted or not.\n     * returns {string} - The equivalent SQL string value\n     */\n    escape(value, unquoted) {\n        if (typeof value === 'boolean') { return value ? '1' : '0'; }\n        if (value instanceof Date) {\n            return util.format('TO_TIMESTAMP_TZ(%s, \\'YYYY-MM-DD HH24:MI:SS.FF3TZH:TZM\\')', this.escapeDate(value));\n        }\n        let res = super.escape.bind(this)(value, unquoted);\n        if (typeof value === 'string') {\n            if (/\\\\'/g.test(res)) {\n                //escape single quote (that is already escaped)\n                res = res.replace(/\\\\'/g, SINGLE_QUOTE_ESCAPE);\n                if (/\\\\\"/g.test(res))\n                //escape double quote (that is already escaped)\n                    res = res.replace(/\\\\\"/g, DOUBLE_QUOTE_ESCAPE);\n                if (/\\\\\\\\/g.test(res))\n                //escape slash (that is already escaped)\n                    res = res.replace(/\\\\\\\\/g, SLASH_ESCAPE);\n            }\n        }\n        return res;\n    }\n\n    /**\n     * @param {Date|*} val\n     * @returns {string}\n     */\n    escapeDate(val) {\n        const year   = val.getFullYear();\n        const month  = zeroPad(val.getMonth() + 1, 2);\n        const day    = zeroPad(val.getDate(), 2);\n        const hour   = zeroPad(val.getHours(), 2);\n        const minute = zeroPad(val.getMinutes(), 2);\n        const second = zeroPad(val.getSeconds(), 2);\n        //var millisecond = zeroPad(dt.getMilliseconds(), 3);\n        //format timezone\n        const offset = (new Date()).getTimezoneOffset(), timezone = (offset<=0 ? '+' : '-') + zeroPad(-Math.floor(offset/60),2) + ':' + zeroPad(offset%60,2);\n        return \"'\" + year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second + \".\" + zeroPad(val.getMilliseconds(), 3) + timezone + \"'\";\n    }\n\n    /**\n     *\n     * @param {QueryExpression} obj\n     * @returns {string}\n     */\n    formatLimitSelect(obj) {\n\n        const sql=this.formatSelect(obj);\n        if (obj.$take) {\n            if (obj.$skip) {\n                return 'SELECT * FROM ( ' +  sql + ' ) where ROWNUM <= ' + (obj.$take + obj.$skip).toString() + ' ROWNUM > ' + obj.$skip.toString();\n            }\n            else {\n                return 'SELECT * FROM ( ' +  sql + ' ) where ROWNUM <= ' + obj.$take.toString();\n            }\n        }\n        return sql;\n    }\n\n    /**\n     * Implements indexOf(str,substr) expression formatter.\n     * @param {string} p0 The source string\n     * @param {string} p1 The string to search for\n     * @returns {string}\n     */\n    $indexof(p0, p1) {\n        return util.format('(INSTR(%s,%s)-1)', this.escape(p0), this.escape(p1));\n    }\n\n    /**\n     * Implements contains(a,b) expression formatter.\n     * @param {string} p0 The source string\n     * @param {string} p1 The string to search for\n     * @returns {string}\n     */\n    $text(p0, p1) {\n        return util.format('(INSTR(%s,%s)-1)>=0', this.escape(p0), this.escape(p1));\n    }\n\n    /**\n     * Implements concat(a,b) expression formatter.\n     * @param {*} p0\n     * @param {*} p1\n     * @returns {string}\n     */\n    $concat(p0, p1) {\n        return util.format('CONCAT(%s,%s)', this.escape(p0),  this.escape(p1));\n    }\n\n    /**\n     * Implements substring(str,pos) expression formatter.\n     * @param {String} p0 The source string\n     * @param {Number} pos The starting position\n     * @param {Number=} length The length of the resulted string\n     * @returns {string}\n     */\n    $substring(p0, pos, length) {\n        if (length)\n            return util.format('SUBSTR(%s,%s,%s)', this.escape(p0), pos.valueOf()+1, length.valueOf());\n        else\n            return util.format('SUBSTR(%s,%s)', this.escape(p0), pos.valueOf()+1);\n    }\n\n    /**\n     * Implements length(a) expression formatter.\n     * @param {*} p0\n     * @returns {string}\n     */\n    $length(p0) {\n        return util.format('LENGTH(%s)', this.escape(p0));\n    }\n\n    $ceiling(p0) {\n        return util.format('CEIL(%s)', this.escape(p0));\n    }\n\n    $startswith(p0, p1) {\n        //validate params\n        if ( _.isNil(p0) ||  _.isNil(p1))\n            return '';\n        return 'REGEXP_LIKE(' + this.escape(p0) + ',\\'^' + this.escape(p1, true) + '\\')';\n    }\n\n    $contains(p0, p1) {\n        //validate params\n        if ( _.isNil(p0) ||  _.isNil(p1))\n            return '';\n        return 'REGEXP_LIKE(' + this.escape(p0) + ',\\'' + this.escape(p1, true) + '\\')';\n    }\n\n    $endswith(p0, p1) {\n        //validate params\n        if ( _.isNil(p0) ||  _.isNil(p1))\n            return '';\n        return 'REGEXP_LIKE(' + this.escape(p0) + ',\\'' + this.escape(p1, true) + '$\\')';\n    }\n\n    $day(p0) {\n        return util.format('EXTRACT(DAY FROM %s)', this.escape(p0)) ;\n    }\n\n    $month(p0) {\n        return util.format('EXTRACT(MONTH FROM %s)', this.escape(p0)) ;\n    }\n\n    $year(p0) {\n        return util.format('EXTRACT(YEAR FROM %s)', this.escape(p0)) ;\n    }\n\n    $hour(p0) {\n        return util.format('EXTRACT(HOUR FROM %s)', this.escape(p0)) ;\n    }\n\n    $minute(p0) {\n        return util.format('EXTRACT(MINUTE FROM %s)', this.escape(p0)) ;\n    }\n\n    $second(p0) {\n        return util.format('EXTRACT(SECOND FROM %s)', this.escape(p0)) ;\n    }\n\n    $date(p0) {\n        //alternative date solution: 'TO_TIMESTAMP_TZ(TO_CHAR(%s, 'YYYY-MM-DD'),'YYYY-MM-DD')'\n        return util.format('TRUNC(%s)', this.escape(p0)) ;\n    }\n\n    /**\n     * Implements contains(a,b) expression formatter.\n     * @param {*} p0 The source string\n     * @param {string|*} p1 The string to search for\n     * @returns {string}\n     */\n    $regex(p0, p1) {\n        //validate params\n        if ( _.isNil(p0) ||  _.isNil(p1))\n            return '';\n        return 'REGEXP_LIKE(' + this.escape(p0) + ',\\'' + this.escape(p1, true) + '\\')';\n    }\n}\n\nOracleFormatter.NAME_FORMAT = '\"$1\"';\n\nconst SINGLE_QUOTE_ESCAPE = '\\'\\'';\nconst DOUBLE_QUOTE_ESCAPE = '\"';\nconst SLASH_ESCAPE = '\\\\';\n\n/**\n * Creates an instance of OracleAdapter object that represents an Oracle database connection.\n * @param {*} options An object that represents the properties of the underlying database connection.\n * @returns {DataAdapter|*}\n */\nexport function createInstance(options) {\n    return new OracleAdapter(options);\n}\n"]}